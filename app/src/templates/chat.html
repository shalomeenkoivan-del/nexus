<!DOCTYPE html>
<html>
<head><title>Nexus Chat</title>
<link rel="icon" href="/data/images/favicon.ico">
<style>
#chat * {
    will-change: transform;
}
#chat {
    transform: translateZ(0);
}
.global-icon { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; filter: drop-shadow(0 0 4px #ff4444); }
.user-icon { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; filter: drop-shadow(0 0 4px #00ff88); }
body{font-family:monospace;background:linear-gradient(45deg,#111,#000,#111);color:#0f0;padding:20px;position:relative;overflow:hidden;}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 80%,rgba(0,255,136,0.1) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,68,68,0.1) 0%,transparent 50%),radial-gradient(circle at 40% 40%,rgba(0,255,0,0.05) 0%,transparent 30%);animation:backgroundShift 10s ease-in-out infinite;z-index:-1;}
.particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1;overflow:hidden;}
.particle{position:absolute;background:#0f0;border-radius:50%;animation:floatParticle 8s infinite linear;}
.container{display:flex;height:calc(100vh - 60px);gap:10px;padding:10px;}
.chat-container{flex:3;display:flex;flex-direction:column;border:2px solid #0f0;box-shadow:0 0 40px #0f0,inset 0 0 20px rgba(0,255,0,0.1);background:linear-gradient(145deg,#000,#111);overflow:hidden;position:relative;}
#chat{flex:1;overflow-y:scroll;border:none;box-shadow:none;padding:15px;background:transparent;margin:0;position:relative;overflow-x:hidden;}
#chat::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#0f0,#00ff88,transparent);animation:scanline 3s linear infinite;}
#chat::-webkit-scrollbar{width:8px;}
#chat::-webkit-scrollbar-track{background:#111;}
#chat::-webkit-scrollbar-thumb{background:linear-gradient(#0f0,#00ff88);border-radius:4px;}
#chat::-webkit-scrollbar-thumb:hover{background:linear-gradient(#00ff88,#0f0);}
.separator-line{height:2px;background:linear-gradient(90deg,transparent,#0f0,#00ff88,transparent);margin:15px 0;animation:scanline 3s linear infinite;}
.input-row{display:flex;align-items:center;gap:10px;padding:15px;background:rgba(0,0,0,0.3);border-top:1px solid #0f0;}
#input{flex:1;padding:20px;background:linear-gradient(145deg,#222,#111);color:#0f0;border:2px solid #0f0;box-shadow:0 0 20px rgba(0,255,0,0.3);font-size:16px;font-family:monospace;transition:all 0.3s ease;}
#input:focus{outline:none;box-shadow:0 0 30px #0f0,0 0 50px rgba(0,255,136,0.5);border-color:#00ff88;}
button{padding:20px 30px;background:linear-gradient(145deg,#0f0,#00ff88);color:#000;border:none;cursor:pointer;font-size:16px;font-family:monospace;font-weight:bold;text-shadow:0 1px 2px #000;box-shadow:0 5px 15px rgba(0,255,0,0.4);transition:all 0.3s ease;position:relative;overflow:hidden;}
button:hover{background:linear-gradient(145deg,#00ff88,#0f0);box-shadow:0 8px 25px rgba(0,255,136,0.6),0 0 40px rgba(0,255,0,0.5);transform:translateY(-2px);}
button:active{transform:translateY(0);}
#logout-btn{background:linear-gradient(145deg,#f00,#cc0000) !important;box-shadow:0 5px 15px rgba(255,0,0,0.4) !important;}
#logout-btn:hover{background:linear-gradient(145deg,#cc0000,#f00) !important;box-shadow:0 8px 25px rgba(255,68,68,0.6),0 0 40px rgba(255,0,0,0.5) !important;}
.message{margin:8px 0;font-size:15px;}
.time{color:#888;}
.system-msg{color:#00ff88;font-style:italic;font-weight:normal;text-shadow:0 0 5px #00ff88;}
.my-message{color:#00ff00 !important;font-weight:bold;text-shadow:0 0 8px #00ff00;}
.my-message b{color:#00ff00 !important;}
.other-message{color:#ffffff;}
.other-message b{color:#cccccc;}
.nyxx-message{color:#ff4444 !important;font-weight:bold !important;text-shadow:0 0 10px #ff0000,0 0 20px #ff4444;}
.nyxx-message b{color:#ff6666 !important;}
.nyxx-enter{color:#ff4444 !important;font-weight:bold !important;text-shadow:0 0 10px #ff0000,0 0 20px #ff4444;font-style:italic;}
.header-bar{display:flex;align-items:center;gap:15px;padding:10px 15px;border-bottom:1px solid #0f0;background:rgba(0,0,0,0.3);}
.header-avatar{width:60px;height:60px;border-radius:8px;border:2px solid #0f0;box-shadow:0 0 20px rgba(0,255,0,0.5);flex-shrink:0;transition:all 0.3s ease;}
.header-avatar:hover{box-shadow:0 0 30px rgba(0,255,136,0.8),0 0 40px rgba(0,255,0,0.6);}
.header-title{flex:1;display:flex;flex-direction:column;}
h1{margin:0;font-size:2.2rem;font-weight:900;background:linear-gradient(45deg,#0f0,#00ff88,#0f0);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:glowText 2s ease-in-out infinite alternate,shimmer 3s linear infinite;text-shadow:0 0 20px #0f0;}
#status-text{color:#ffffff !important;font-weight:bold !important;font-size:13px;margin:0;padding:0;background:none;border:none;text-shadow:0 0 5px #ffffff;}
.rooms-panel{flex:1;border:2px solid #0f0;box-shadow:0 0 40px #0f0,inset 0 0 20px rgba(0,255,0,0.1);background:linear-gradient(145deg,#000,#111);display:flex;flex-direction:column;overflow:hidden;position:relative;}
.rooms-header {
    color: #00ff88;
    font-weight: bold;
    padding: 15px;
    background: linear-gradient(145deg, rgba(0,255,136,0.1), transparent);
    border-bottom: 2px solid #0f0;
    text-shadow: 0 0 10px #00ff88;
    font-size: 16px;
    border-radius: 10px 10px 0 0;
    position: relative;
    overflow: hidden;
}
.rooms-header.global {
    background: linear-gradient(145deg, rgba(255,68,68,0.2), rgba(255,0,0,0.1));
    color: #ff4444;
    text-shadow: 0 0 10px #ff4444;
}
.rooms-header.user {
    background: linear-gradient(145deg, rgba(0,255,136,0.2), rgba(0,255,0,0.1));
    color: #00ff88;
    text-shadow: 0 0 10px #00ff88;
}
.rooms-header::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, transparent, #0f0, #00ff88, transparent);
    animation: scanline 3s linear infinite;
    border-radius: 0 0 5px 5px;
}
.rooms-list{flex:1;padding:15px;overflow-y:auto;}
.room-item{padding:12px 15px;margin:8px 0;border-radius:6px;cursor:pointer;transition:all 0.3s ease;color:#0f0;font-family:monospace;font-size:14px;text-shadow:0 0 5px #0f0;background:rgba(0,255,0,0.08);border:1px solid rgba(0,255,0,0.3);user-select:none;position:relative;}
.room-item:hover{background:rgba(0,255,136,0.2);border-color:#00ff88;box-shadow:0 0 15px rgba(0,255,0,0.4);transform:translateX(3px);}
.room-item.general{background:linear-gradient(145deg,#00ff88,#0f0);color:#000;border:2px solid #00ff88;font-weight:bold;text-shadow:none;box-shadow:0 0 20px rgba(0,255,136,0.6);position:sticky;top:0;z-index:10;}
.room-item.general:hover{background:linear-gradient(145deg,#0f0,#00ff88) !important;transform:none !important;}
.room-item.selected{background:linear-gradient(145deg,#ff4444,#cc0000);color:#fff;border:1px solid #ff6666;text-shadow:0 0 8px #ff4444;font-weight:bold;}
.room-item.add-room{background:linear-gradient(145deg,rgba(0,255,136,0.2),rgba(0,255,0,0.1));color:#00ff88;font-size:24px;font-weight:bold;text-align:center;line-height:1.2;border:2px solid #00ff88;text-shadow:0 0 10px #00ff88;}
.global-room {
    background: linear-gradient(145deg, #ff4444, #cc0000, rgba(204, 0, 0, 0.3), transparent) !important;
    color: #fff !important;
    border: 2px solid #ff6666 !important;
    font-weight: bold !important;
    text-shadow: 0 0 8px #ff4444 !important;
    margin-bottom: 5px !important;
}   
.global-room:hover {
    background: linear-gradient(145deg, #cc0000, #ff4444) !important;
    box-shadow: 0 0 20px rgba(255, 68, 68, 0.8) !important;
}
.global-room.selected {
    background: linear-gradient(145deg, #00ff88, #0f0) !important;
    color: #000 !important;
    border-color: #00ff88 !important;
}
.user-room {
    background: linear-gradient(145deg, rgba(0,255,136,0.3), rgba(0,255,0,0.15), rgba(0,255,0,0.05), transparent) !important;
    border: 1px solid rgba(0,255,136,0.4) !important;
}
.user-room:hover {
    background: rgba(0,255,136,0.25) !important;
    border-color: #00ff88 !important;
}
.user-room.selected {
    background: linear-gradient(145deg, #00ff88, #0f0) !important;
    color: #000 !important;
    border: 3px solid #00ff88 !important;
    box-shadow: 0 0 25px rgba(0,255,136,0.9), inset 0 0 15px rgba(0,255,136,0.3) !important;
    transform: scale(1.02) !important;
    text-shadow: none !important;
    font-weight: bold !important;
}
.user-room.selected:hover {
    background: linear-gradient(145deg, #0f0, #00ff88) !important;
    box-shadow: 0 0 35px rgba(0,255,136,1) !important;
}
.room-delete-btn {
    right: 8px !important;
    position: absolute !important;
    top: 50%; 
    transform: translateY(-50%) !important;
    color: #ff4444 !important; 
    font-size: 14px !important; 
    font-weight: bold !important; 
    cursor: pointer !important; 
    opacity: 0.7 !important; 
    transition: all 0.2s !important;
    text-shadow: 0 0 3px #ff0000 !important;
    pointer-events: auto !important;
    background: rgba(255,0,0,0.2);
    border-radius: 50%;
    width: 20px !important;
    height: 20px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-family: monospace !important;
    z-index: 18 !important;
}
.room-delete-btn:hover {
    opacity: 1 !important;
    background: rgba(255,68,68,0.4) !important;
    transform: translateY(-50%) scale(1.2) !important;
}
.unread-badge {
    right: 36px !important;
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: linear-gradient(145deg, #ff4444, #cc0000) !important;
    color: #fff !important;
    border: 1px solid #ff6666 !important;
    border-radius: 50% !important;
    width: 20px !important;
    height: 20px !important;
    font-size: 10px !important;
    font-weight: bold !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-shadow: 0 0 3px #ff0000 !important;
    box-shadow: 0 0 8px rgba(255,68,68,0.8) !important;
    animation: pulse 1s infinite !important;
    z-index: 19 !important;
    min-width: 20px !important;
    animation: none !important;
}
.unread-badge.zero {
    background: linear-gradient(145deg, #0f0, #00ff88) !important;
    border-color: #00ff88 !important;
    box-shadow: 0 0 8px rgba(0,255,136,0.8) !important;
    color: #000 !important;
    text-shadow: none !important;
}
.unread-badge.has-unread {
    background: linear-gradient(145deg, #ff4444, #cc0000) !important;
    color: #fff !important;
    border-color: #ff6666 !important;
    box-shadow: 0 0 8px rgba(255,68,68,0.8) !important;
    text-shadow: 0 0 3px #ff0000 !important;
    animation: pulse 1s infinite !important;
}
@keyframes pulse {
    0%, 100% { transform: translateY(-50%) scale(1); }
    50% { transform: translateY(-50%) scale(1.15); }
}
.room-item:hover .room-delete-btn {
    opacity: 1 !important;
}
.room-item.dragging{opacity:0.5;transform:rotate(5deg);}
.room-item.drag-over {
    background: rgba(255,68,68,0.4) !important;
    border-color: #ff4444 !important;
    transform: translateX(5px) scale(1.02) !important;
}
.rooms-list::-webkit-scrollbar{width:6px;}
.rooms-list::-webkit-scrollbar-track{background:#111;}
.rooms-list::-webkit-scrollbar-thumb{background:linear-gradient(#0f0,#00ff88);border-radius:3px;}
.rooms-list::-webkit-scrollbar-thumb:hover{background:linear-gradient(#00ff88,#0f0);}
@keyframes glowText{0%{filter:drop-shadow(0 0 10px #0f0);}100%{filter:drop-shadow(0 0 30px #0f0) drop-shadow(0 0 50px #00ff88);}}
@keyframes shimmer{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
@keyframes scanline{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes backgroundShift{0%,100%{background-position:0% 50%,50% 50%,20% 80%}50%{background-position:100% 50%,100% 50%,80% 20%}}
@keyframes floatParticle{0%{transform:translateY(100vh) rotate(0deg);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-100px) rotate(360deg);opacity:0}}
.nyxx-glow {
    color: #00FF88 !important;
    font-weight: 900 !important;
    text-shadow: 
        0 0 15px #00FF88,
        0 0 25px #00FF88,
        0 0 40px #00FF88 !important;
    animation: nyxxGlow 2s ease-in-out infinite alternate !important;
}
.system-msg span[style*="FFFFFF"] {
    color: #FFFFFF !important;
    text-shadow: 0 0 10px #FFFFFF !important;
    font-weight: bold !important;
}
@keyframes nyxxGlow {
    0% { 
        text-shadow: 
            0 0 15px #00FF88, 
            0 0 30px #00FF88,
            0 0 50px #00FF88;
    }
    100% { 
        text-shadow: 
            0 0 25px #00FF88, 
            0 0 40px #00FF88,
            0 0 60px #00FF88,
            0 0 80px #00FF88;
    }
}
.add-room {
    pointer-events: auto !important;
    position: relative !important;
}
.status-icon {
    right: 64px !important;
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 20px !important;
    height: 20px !important;
    filter: drop-shadow(0 0 4px #00ff88) !important;
    z-index: 15 !important;
    object-fit: contain !important;
    border-radius: 3px !important;
}
.crown-icon {
    right: 92px !important;
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 20px !important;
    height: 20px !important;
    filter: drop-shadow(0 0 6px #ffaa00) !important;
    z-index: 17 !important;
    object-fit: contain !important;
    border-radius: 3px !important;
}
.context-menu {
    position: fixed;
    background: linear-gradient(145deg, #111, #000);
    border: 2px solid #0f0;
    border-radius: 8px;
    box-shadow: 0 0 30px rgba(0,255,0,0.5);
    z-index: 1000;
    padding: 8px 0;
    min-width: 160px;
    display: none;
    font-family: monospace;
}
.context-menu-item {
    padding: 10px 15px;
    color: #0f0;
    cursor: pointer;
    border-bottom: 1px solid rgba(0,255,0,0.2);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}
.context-menu-item:hover {
    background: rgba(0,255,136,0.2);
    color: #00ff88;
    box-shadow: inset 3px 0 #00ff88;
}
.context-menu-item:last-child {
    border-bottom: none;
}
.lock-item { color: #ffc107; }
.unlock-item { color: #00ff88; }
.delete-item { color: #ff4444; }
</style>
</head>
<body>
<div id="fade-overlay" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: black;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease-in-out;
  z-index: 9999;
"></div>
<div id="context-menu" class="context-menu">
    <div class="context-menu-item lock-item" id="menu-lock">üîí LOCK</div>
    <div class="context-menu-item unlock-item" id="menu-unlock">üîì UNLOCK</div>
    <div class="context-menu-item delete-item" id="menu-delete">üóëÔ∏è DELETE</div>
</div>
<div class="particles" id="particles"></div>

<div class="container">
    <div class="chat-container">
        <div class="header-bar">
            <img id="status-avatar" class="header-avatar" src="/data/images/avatar.png" alt="Avatar">
            <div class="header-title">
                <h1>Nexus Chat</h1>
                <div id="status-text">Loading...</div>
            </div>
        </div>
        <div id="chat"></div>
        <div class="separator-line"></div>
        <div class="input-row">
            <input type="text" id="input" placeholder="Type your message..." autofocus>
            <button onclick="sendMessage()">Send</button>
            <button id="logout-btn" onclick="logout()">Log out</button>
        </div>
    </div>

    <div class="rooms-panel">
        <div class="rooms-header" style="text-align: center;">SHADOW ROOMS</div>
        <div class="rooms-list" id="rooms-list">
        </div>
    </div>
</div>

<script>
let chat = document.getElementById('chat');
let MY_USERNAME = null;
let currentRoom = 'general';
let draggedItem = null;
let globalRooms = [];
let userRooms = [];
let isNyxx = false;
let colorCache = {};
let lastMessageTime = null;
let seenMessages = new Set();
let notificationsInitialized = false;
let notificationsEnabled = false;
let notifyButton = null;
let localUnread = {};
let contextMenu = document.getElementById('context-menu');
let currentContextRoom = null;
let roomCreators = {};
let roomStatuses = {};
let cachedGlobalRooms = [];
let cachedUserRooms = [];
let previousUnread = {};

async function refreshRoomListIfNeeded() {
    try {
        const response = await fetch('/rooms_separated_with_unread');
        if (!response.ok) return;

        const data = await response.json();
        const { global_rooms, user_rooms, unread_counts } = data;

        const arraysEqual = (a, b) => {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        };

        const globalChanged = !arraysEqual(globalRooms, global_rooms);
        const userChanged = !arraysEqual(userRooms, user_rooms);

        if (globalChanged || userChanged) {
            globalRooms = global_rooms;
            userRooms = user_rooms;
            isNyxx = data.is_nyxx || false;
            renderRooms();
        }

        const newUnread = unread_counts || {};
        for (const room in newUnread) {
            if (room === currentRoom) continue;
            const oldCount = previousUnread[room] || 0;
            const newCount = newUnread[room];
            if (newCount > oldCount && newCount > 0) {
                fetch(`/chat_history?room=${encodeURIComponent(room)}&t=${Date.now()}`)
                    .then(res => res.json())
                    .then(historyData => {
                        if (historyData.history.length > 0) {
                            const lastMsg = historyData.history[historyData.history.length - 1];
                            showChatNotification(lastMsg.user, lastMsg.message);
                        }
                    })
                    .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', err));
            }
        }

        localUnread = newUnread;
        previousUnread = JSON.parse(JSON.stringify(newUnread));
        updateUnreadBadges();

    } catch (err) {
        console.error('Error in refreshRoomListIfNeeded:', err);
    }
}

function showContextMenu(roomName, x, y, isCreator, isPrivate) {
    currentContextRoom = roomName;
    contextMenu.style.display = 'block';
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    
    document.getElementById('menu-lock').style.display = isCreator && !isPrivate ? 'flex' : 'none';
    document.getElementById('menu-unlock').style.display = isCreator && isPrivate ? 'flex' : 'none';
    document.getElementById('menu-delete').style.display = isCreator ? 'flex' : 'none';
}

function hideContextMenu() {
    contextMenu.style.display = 'none';
    currentContextRoom = null;
}

document.getElementById('menu-lock').onclick = async () => {
    if (!currentContextRoom) return;
    const password = prompt('Enter password to make room private:');
    if (password !== null) {
        await lockRoom(currentContextRoom, password);
        hideContextMenu();
    }
};

document.getElementById('menu-unlock').onclick = async () => {
    if (!currentContextRoom) return;
    if (confirm('Are you sure to unlock the room? Your password wiil be reseted.')) {
        await unlockRoom(currentContextRoom);
        hideContextMenu();
    }
};

document.getElementById('menu-delete').onclick = async () => {
    if (!currentContextRoom) return;
    if (confirm(`DELETE room "${currentContextRoom}" with all data forever?`)) {
        await rmrfRoom(currentContextRoom);
        hideContextMenu();
    }
};

async function rmrfRoom(roomName) {
    try {
        const response = await fetch('/rmrf_room', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({room: roomName})
        });
        const data = await response.json();
        if (data.success) {
            alert(data.message || `Room "${roomName}" was fully deleted with data`);
            loadRoomsSeparated();
        } else {
            alert(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    } catch(err) {
        console.error('rmrf error:', err);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã');
    }
}

async function lockRoom(roomName, password) {
    try {
        const response = await fetch('/lock_room', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({room: roomName, password: password || ''})
        });
        const data = await response.json();
        if (data.success) {
            alert(data.message);
            loadRoomsSeparated();
            loadFullChatHistory();
        } else {
            alert(data.message);
        }
    } catch(err) {
        console.error('Lock error:', err);
        alert('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
    }
}

async function unlockRoom(roomName) {
    try {
        const response = await fetch('/unlock_room', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({room: roomName})
        });
        const data = await response.json();
        if (data.success) {
            alert(data.message);
            loadRoomsSeparated();
            loadFullChatHistory();
        } else {
            alert(data.message);
        }
    } catch(err) {
        console.error('Unlock error:', err);
        alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
    }
}

document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target)) {
        hideContextMenu();
    }
});

function loadRoomsSeparated() {
    fetch('/rooms_separated_with_unread')
    .then(r => r.json())
    .then(data => {
        globalRooms = data.global_rooms || [];
        userRooms = data.user_rooms || [];
        const serverUnread = data.unread_counts || {};
        for (let room in serverUnread) {
            if (room !== currentRoom) {
                localUnread[room] = serverUnread[room];
            }
        }
        isNyxx = data.is_nyxx || false;
        renderRooms();
    })
    .catch(err => console.error('Rooms load error:', err));
}

function renderRooms() {
    const roomsList = document.getElementById('rooms-list');
    roomsList.innerHTML = '';
    
    const globalHeader = document.createElement('div');
    globalHeader.className = 'rooms-header';
    globalHeader.className = 'rooms-header global';
    globalHeader.innerHTML = '<img src="/data/images/global-icon.png" class="global-icon"> GLOBAL';
    globalHeader.style.background = 'linear-gradient(145deg,rgba(255,68,68,0.2),rgba(255,0,0,0.1))';
    globalHeader.style.color = '#ff4444';
    globalHeader.style.textShadow = '0 0 10px #ff4444';
    roomsList.appendChild(globalHeader);
    
    globalRooms.forEach(roomName => {
        const roomItem = document.createElement('div');
        roomItem.className = `room-item global-room${currentRoom === roomName ? ' selected' : ''}${roomName === 'general' ? ' general' : ''}`;
        roomItem.dataset.room = roomName;
        
        const roomText = document.createElement('span');
        roomText.textContent = roomName;
        roomItem.appendChild(roomText);
        
        if (isNyxx && roomName !== 'general') {
            const deleteBtn = document.createElement('span');
            deleteBtn.innerHTML = '‚úï';
            deleteBtn.className = 'room-delete-btn';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`Delete GLOBAL room "${roomName}"?`)) deleteUserRoom(roomName);
            };
            roomItem.appendChild(deleteBtn);
        }
        
        const unreadCount = (localUnread[roomName] || 0);
        if (unreadCount > 0 && roomName !== currentRoom) {
            const badge = document.createElement('div');
            badge.className = 'unread-badge has-unread';
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            roomItem.appendChild(badge);
        }
        
        roomItem.onclick = (e) => {
            if (!e.target.classList.contains('room-delete-btn')) switchRoom(roomName);
        };
        roomsList.appendChild(roomItem);
    });
    
    if (!isNyxx) {
        const separator = document.createElement('div');
        separator.style.cssText = 'height:12px;background:linear-gradient(90deg,transparent,#0f0,transparent);margin:10px 0';
        roomsList.appendChild(separator);
        
        const userHeader = document.createElement('div');
        userHeader.className = 'rooms-header';
        userHeader.className = 'rooms-header user';
        userHeader.innerHTML = '<img src="/data/images/user-icon.png" class="user-icon"> USER';
        userHeader.style.background = 'linear-gradient(145deg,rgba(0,255,136,0.1),transparent)';
        roomsList.appendChild(userHeader);
        
        userRooms.forEach((roomName, index) => {
            const roomItem = document.createElement('div');
            roomItem.className = `room-item user-room reorderable${currentRoom === roomName ? ' selected' : ''}`;
            roomItem.draggable = true;
            roomItem.dataset.room = roomName;
            roomItem.dataset.index = index;
            roomItem.style.position = 'relative';
            
            const roomText = document.createElement('span');
            roomText.textContent = roomName;
            roomText.style.display = 'block';
            roomItem.appendChild(roomText);
            
            const deleteBtn = document.createElement('span');
            deleteBtn.innerHTML = '‚úï';
            deleteBtn.className = 'room-delete-btn';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`Delete room "${roomName}"?\nChat history will remain.`)) deleteUserRoom(roomName);
            };
            roomItem.appendChild(deleteBtn);
            
            const unreadCount = localUnread[roomName] || 0;
            const badge = document.createElement('div');
            badge.className = 'unread-badge';
            updateBadgeContent(badge, unreadCount, roomName);
            roomItem.appendChild(badge);
            
            roomItem.onclick = (e) => {
                if (!e.target.classList.contains('room-delete-btn')) switchRoom(roomName);
            };
            roomItem.addEventListener('contextmenu', async (e) => {
                e.preventDefault();
                try {
                    const creatorData = await fetch(`/room_status_crown?room=${roomName}`).then(r => r.json()).catch(() => ({is_creator: false}));
                    const statusData = await fetch(`/room_status?room=${roomName}`).then(r => r.json()).catch(() => ({privacy: 'public'}));
                    showContextMenu(roomName, e.clientX, e.clientY, creatorData.is_creator, statusData.privacy === 'private');
                } catch(err) {
                    console.error('Context menu error:', err);
                }
            });
            roomsList.appendChild(roomItem);
        });        
        
        loadRoomIcons(userRooms);

        const addButton = document.createElement('div');
        addButton.className = 'room-item add-room';
        addButton.textContent = '+';
        addButton.onclick = showAddRoom;
        roomsList.appendChild(addButton);
    } else {
        const nyxxAddButton = document.createElement('div');
        nyxxAddButton.className = 'room-item add-room';
        nyxxAddButton.style.cssText = 'background:linear-gradient(145deg,#ff4444,#cc0000)!important;color:#fff!important;border-color:#ff6666!important';
        nyxxAddButton.textContent = '+';
        nyxxAddButton.onclick = showAddRoom;
        roomsList.appendChild(nyxxAddButton);
    }
}

function updateBadgeContent(badge, count, roomName) {
    badge.textContent = count > 99 ? '99+' : count;
    badge.className = 'unread-badge';
    
    if (count === 0 || roomName === currentRoom) {
        badge.classList.add('zero');
        badge.textContent = '';
    } else {
        badge.classList.add('has-unread');
    }
}

function loadRoomIcons(roomNames) {
    Promise.all(roomNames.map(roomName =>
        Promise.all([
            fetch(`/room_status?room=${roomName}`).then(r => r.json()).catch(() => ({privacy: null})),
            fetch(`/room_status_crown?room=${roomName}`).then(r => r.json()).catch(() => ({is_creator: false}))
        ])
    )).then(results => {
        results.forEach(([status, crown], index) => {
            const roomItem = document.querySelector(`[data-room="${roomNames[index]}"]`);
            if (!roomItem) return;

            const existingPrivacy = roomItem.querySelector('.privacy-icon');
            const existingCrown = roomItem.querySelector('.crown-icon');
            if (existingPrivacy) existingPrivacy.remove();
            if (existingCrown) existingCrown.remove();

            if (status.privacy === 'public' || status.privacy === 'private') {
                const img = document.createElement('img');
                img.src = status.icon;
                img.className = 'status-icon privacy-icon';
                roomItem.appendChild(img);
            }

            if (crown.is_creator) {
                const crownImg = document.createElement('img');
                crownImg.src = crown.icon;
                crownImg.className = 'crown-icon crown-icon';
                roomItem.appendChild(crownImg);
            }
        });
    });
}

function deleteUserRoom(roomName) {
    fetch('/delete_room', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({room: roomName})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadRoomsSeparated();
            if (currentRoom === roomName) {
                currentRoom = 'general';
                loadFullChatHistory();
            }
        } else {
            alert(data.message);
        }
    })
    .catch(err => console.error('Delete error:', err));
}

function showAddRoom() {
  let roomName = prompt('Enter room name:');
  if (!roomName || roomName.toLowerCase() === 'general') return;

  joinRoom(roomName, null);
}

function joinRoom(roomName, password) {
  fetch('/add_room', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({room: roomName, password: password})
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      loadRoomsSeparated();
      if (data.switch_to) {
        switchRoom(data.switch_to);
      }
    } else if (data.needs_password) {
      const pwd = prompt(`Enter password for room "${roomName}":`);
      if (pwd !== null) {
        joinRoom(roomName, pwd);
      }
    } else {
      alert(data.message || 'Error joining room');
    }
  })
  .catch(err => console.error('Error:', err));
}

function switchRoom(roomName) {
    currentRoom = roomName;
    lastMessageTime = null;
    
    seenMessages = new Set();
    
    fetch('/set_current_room', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({room: roomName})
    });
    
    localUnread[roomName] = 0;
    
    document.querySelectorAll('.room-item').forEach(item => 
        item.classList.remove('selected')
    );
    const targetRoom = document.querySelector(`[data-room="${roomName}"]`);
    if (targetRoom) targetRoom.classList.add('selected');
    
    loadFullChatHistory();
}

function loadFullChatHistory() {
    fetch(`/chat_history?room=${currentRoom}&t=${Date.now()}`)
    .then(response => response.json())
    .then(data => {
        chat.innerHTML = '';
        lastMessageTime = null;

        if (data.history.length > 0) {
            data.history.forEach(msg => {
                appendMessage(msg);
                lastMessageTime = msg.time;
            });
        } else {
            lastMessageTime = "";
        }
        
        chat.scrollTop = chat.scrollHeight;
        
        fetch('/mark_read', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({room: currentRoom})
        }).then(() => {
            localUnread[currentRoom] = 0;
            updateUnreadBadges();
        });
    })
    .catch(err => console.error('Full history load error:', err));
}

function createNotificationToggle() {
    if (notifyButton) return;
    
    notifyButton = document.createElement('button');
    notifyButton.id = 'notify-btn';
    notifyButton.innerHTML = notificationsEnabled ? '‚úÖ –ê–ö–¢–ò–í–ù–û' : 'üîî –í–ö–õ. –ó–í–£–ö';

    updateButtonState();
    
    notifyButton.style.cssText = `
        padding: 12px 20px !important;
        font-size: 14px !important;
        margin-left: 10px !important;
        font-family: monospace !important;
        font-weight: bold !important;
        border: none !important;
        border-radius: 25px !important;
        cursor: pointer !important;
        position: relative !important;
        z-index: 1000 !important;
    `;
    
    notifyButton.addEventListener('click', function(e) {
        e.stopPropagation();
        notificationsEnabled = !notificationsEnabled;
        updateButtonState();
        if (notificationsEnabled) playNotificationSound();
        console.log(notificationsEnabled ? "üîî –í–ö–õ" : "üîá –í–´–ö–õ");
    });
    
    document.querySelector('.header-bar').appendChild(notifyButton);
}

function updateButtonState() {
    if (!notifyButton) return;
    
    if (notificationsEnabled) {
        notifyButton.innerHTML = '<img src="/data/images/notify_on.png" style="width:20px;height:20px;vertical-align:middle"> ON';
        notifyButton.style.background = 'linear-gradient(145deg, #0f0, #00ff88)';
        notifyButton.style.color = 'black';
        notifyButton.style.boxShadow = '0 5px 20px rgba(0,255,0,0.6)';
    } else {
        notifyButton.innerHTML = '<img src="/data/images/notify_off.png" style="width:20px;height:20px;vertical-align:middle"> OFF';
        notifyButton.style.background = 'linear-gradient(145deg, #ff4444, #cc0000)';
        notifyButton.style.color = 'white';
        notifyButton.style.boxShadow = '0 5px 20px rgba(255,0,0,0.6)';
    }
}

function initNotifications() {
    if (notificationsInitialized) return;
    notificationsInitialized = true;

    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
            console.log("Notification Permission:", permission);
            if (permission === "granted") {
                console.log("–ü–£–®–ò –†–ê–ó–†–ï–®–ï–ù–´!");
            } else {
                console.log("–ü–£–®–ò –ó–ê–ü–†–ï–©–ï–ù–´!");
            }
        });
    }
    
    createNotificationToggle();
}

function showChatNotification(user, message) {
    if (!notificationsEnabled) return;
    
    playNotificationSound();
    
    if (Notification.permission === "granted") {
        const notification = new Notification('Nexus Chat', {
            body: `${user}: ${message}`,
            icon: '/data/images/avatar.png'
        });
        notification.onclick = () => window.focus();
    }
}

function appendMessage(msg) {
    const div = document.createElement('div');
    
    if (msg.user_id === 'SYSTEM') {
        div.className = 'message system-msg';
        div.innerHTML = `<span class="time">[${msg.time}]</span> <span style="color: #FFFFFF; font-weight: bold; text-shadow: 0 0 10px #FFFFFF;">${msg.user}</span> ${msg.message}`;
    }
    else if (msg.user_id === 'NYXX_MASTER') {
        div.className = 'message nyxx-message';
        div.innerHTML = `<span class="time">[${msg.time}]</span> <span class="nyxx-glow">${msg.user}:</span> ${msg.message}`;
    }
    else if (msg.user === MY_USERNAME) {
        div.className = 'message my-message';
        div.innerHTML = `<span class="time">[${msg.time}]</span> <b>${msg.user}:</b> ${msg.message}`;
    }
    else {
        const color = colorCache[msg.user_id] || '#ccc';
        div.className = 'message other-message';
        div.innerHTML = `<span class="time">[${msg.time}]</span> <span style="color: ${color}; text-shadow: 0 0 8px ${color};">${msg.user}:</span> ${msg.message}`;
        
        if (msg.user_id && !colorCache[msg.user_id]) {
            fetch(`/user_color/${msg.user_id}`)
            .then(r => r.json())
            .then(data => colorCache[msg.user_id] = data.color)
            .catch(() => {});
        }
    }
    chat.appendChild(div);
}

function initDragAndDrop() {
    const roomsList = document.getElementById('rooms-list');
    
    roomsList.addEventListener('dragstart', (e) => {
        draggedItem = e.target.closest('.reorderable');
        if (draggedItem) {
            draggedItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
    });
    
    roomsList.addEventListener('dragend', (e) => {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }
    });
    
    roomsList.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const target = e.target.closest('.reorderable');
        if (!target || target === draggedItem) return;
        const rect = target.getBoundingClientRect();
        const nextElement = (e.clientY > rect.top + rect.height / 2) ? target.nextSibling : target;
        if (nextElement && nextElement.classList && nextElement.classList.contains('add-room')) {
            roomsList.insertBefore(draggedItem, target.nextSibling);
        } else {
            roomsList.insertBefore(draggedItem, nextElement);
        }
    });
    
    roomsList.addEventListener('drop', (e) => {
        e.preventDefault();
        const reorderableItems = Array.from(roomsList.querySelectorAll('.reorderable'));
        const newOrder = reorderableItems.map(item => item.dataset.room);
        
        fetch('/save_user_rooms_order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({rooms: newOrder})
        }).catch(err => console.error('Silent save failed:', err));
    });
}

function createParticle() {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.width = particle.style.height = (Math.random() * 4 + 1) + 'px';
    particle.style.animationDuration = (Math.random() * 3 + 5) + 's';
    particle.style.animationDelay = Math.random() * 2 + 's';
    document.getElementById('particles').appendChild(particle);
    setTimeout(() => particle.remove(), 9000);
}
setInterval(createParticle, 200);

function getCurrentUser() {
    return fetch('/current_user').then(r => r.json()).then(data => {
        MY_USERNAME = data.username;
    });
}

function updateChat() {
    const since = lastMessageTime || '';
    fetch(`/chat_history?room=${currentRoom}&since=${encodeURIComponent(since)}&t=${Date.now()}`)
    .then(response => response.json())
    .then(data => {
        if (data.history.length === 0) return;
        
        data.history.forEach(msg => {
            const key = `${msg.time}|${msg.user}|${msg.message || ''}`;
            if (seenMessages.has(key)) return;
            if (msg.time <= lastMessageTime) return;
            appendMessage(msg);
            lastMessageTime = msg.time;
            seenMessages.add(key);
        });
        
        const wasAtBottom = chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 100;
        if (wasAtBottom) {
            chat.scrollTop = chat.scrollHeight;
        }
    })
    .catch(err => console.error('Chat update error:', err));
}

function updateStatus() {
    fetch('/status').then(r => r.json()).then(data => {
        let avatar = document.getElementById('status-avatar');
        let text = document.getElementById('status-text');
        if (data.current_user === 'NYXX') {
            avatar.src = '/data/images/nyxx.png?' + Date.now();
            avatar.onerror = () => avatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmZjQ0NDQiLz4KPHRleHQgeD0iMzAiIHk9IjM2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIiBmb250LXNpemU9IjI0IiBmaWxsPSIjZmYwMDAwIj5OPC90ZXh0Pgo8L3N2Zz4K';
            text.innerHTML = `Entered the Shadows as: NYXX | Online: ${data.online_users}`;
        } else {
            avatar.src = '/data/images/avatar.png?' + Date.now();
            avatar.onerror = () => avatar.src = 'image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiMzMzMiLz4KPHRleHQgeD0iMzAiIHk9IjM2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIiBmb250LXNpemU9IjI0IiBmaWxsPSIjMGYwIj5BPC90ZXh0Pgo8L3N2Zz4K';
            text.innerHTML = `Entered the Shadows as: ${data.current_user} | Online: ${data.online_users}`;
        }
    });
}

function logout() {
  fetch('/command', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({command: 'exit'})
  }).then(() => {
    const overlay = document.getElementById('fade-overlay');
    if (overlay) {
      overlay.style.opacity = '1';
      setTimeout(() => {
        window.location.replace('/console');
      }, 500);
    } else {
      window.location.replace('/console');
    }
  });
}

function updateUnreadBadges() {
  document.querySelectorAll('.room-item[data-room]:not(.add-room)').forEach(item => {
    const roomName = item.dataset.room;
    if (!roomName) return;

    const count = localUnread[roomName] || 0;
    const isGlobal = item.classList.contains('global-room');
    let badge = item.querySelector('.unread-badge');

    if (isGlobal) {
      if (count > 0 && roomName !== currentRoom) {
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'unread-badge has-unread';
          item.appendChild(badge);
        }
        badge.textContent = count > 99 ? '99+' : count;
        badge.className = 'unread-badge has-unread';
      } else {
        if (badge) badge.remove();
      }
    }

    else {
      if (!badge) {
        badge = document.createElement('div');
        badge.className = 'unread-badge';
        item.appendChild(badge);
      }

      if (count === 0 || roomName === currentRoom) {
        badge.className = 'unread-badge zero';
        badge.textContent = '';
      } else {
        badge.className = 'unread-badge has-unread';
        badge.textContent = count > 99 ? '99+' : count;
      }
    }
  });
}

function refreshLocalUnreadFromServer() {
    fetch('/unread_counts_only')
    .then(r => r.json())
    .then(data => {
        const serverUnread = data.unread_counts || {};
        
        for (let room in serverUnread) {
            if (room === currentRoom) continue;
            
            const oldCount = localUnread[room] || 0;
            const newCount = serverUnread[room];
            
            if (newCount > oldCount && newCount > 0) {
                fetch(`/chat_history?room=${room}&t=${Date.now()}`)
                .then(res => res.json())
                .then(historyData => {
                    if (historyData.history.length > 0) {
                        const lastMsg = historyData.history[historyData.history.length - 1];
                        showChatNotification(lastMsg.user, lastMsg.message);
                    }
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', err));
            }
            
            localUnread[room] = newCount;
        }
        
        updateUnreadBadges();
    })
    .catch(err => console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è unread:', err));
}

document.getElementById('input').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});

function requestNotificationPermission() {
    if (!("Notification" in window)) {
        console.log("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è");
        return;
    }
    
    if (Notification.permission === "granted") {
        console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã");
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initDragAndDrop();
    
    getCurrentUser().then(() => {
        initNotifications();
        loadRoomsSeparated();
        loadFullChatHistory();
        
        fetch('/set_current_room', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({room: 'general'})
        });
        
        updateStatus();
        setTimeout(refreshLocalUnreadFromServer, 1000);
    });
});

function sendMessage() {
    let message = document.getElementById('input').value.trim();
    if (!message) return;

    fetch('/chat_send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message, room: currentRoom})
    })
    .then(() => {

    });
    document.getElementById('input').value = '';
}

const notificationSound = new Audio('/data/sounds/notify.mp3');

function playNotificationSound() {
    notificationSound.currentTime = 0;
    notificationSound.play().catch(e => {
        console.log("–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:", e);
    });
}

function refreshRoomIcons() {
    const allRoomItems = document.querySelectorAll('.room-item[data-room]:not(.add-room)');
    const roomNames = Array.from(allRoomItems).map(item => item.dataset.room);

    if (roomNames.length === 0) return;

    Promise.all(roomNames.map(roomName =>
        Promise.all([
            fetch(`/room_status?room=${encodeURIComponent(roomName)}`).then(r => r.json()).catch(() => ({privacy: 'public'})),
            fetch(`/room_status_crown?room=${encodeURIComponent(roomName)}`).then(r => r.json()).catch(() => ({is_creator: false}))
        ])
    )).then(results => {
        results.forEach(([status, crown], index) => {
            const roomName = roomNames[index];
            const roomItem = document.querySelector(`[data-room="${CSS.escape(roomName)}"]`);
            if (!roomItem) return;

            const existingPrivacy = roomItem.querySelector('.privacy-icon');
            const existingCrown = roomItem.querySelector('.crown-icon');
            if (existingPrivacy) existingPrivacy.remove();
            if (existingCrown) existingCrown.remove();

            if (status.privacy === 'public' || status.privacy === 'private') {
                const img = document.createElement('img');
                img.src = status.icon;
                img.className = 'status-icon privacy-icon';
                roomItem.appendChild(img);
            }
            if (crown.is_creator) {
                const crownImg = document.createElement('img');
                crownImg.src = crown.icon;
                crownImg.className = 'status-icon crown-icon';
                roomItem.appendChild(crownImg);
            }
        });
    }).catch(err => console.error('Error refreshing room icons:', err));
}

setInterval(() => {
    updateChat();
    updateStatus();
    refreshRoomIcons();
}, 800);

setInterval(() => {
    refreshRoomListIfNeeded();
}, 2000);
</script>
</body>
</html>